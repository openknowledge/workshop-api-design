<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Onlineshop</title>
  </head>
  <body>
    <h1>Onlineshop</h1>
    <button id="loginButton">Login</button>
    <div id="result"></div>
    <script>
        const authorizeEndpoint = "http://localhost:9191/realms/master/protocol/openid-connect/auth";
        const tokenEndpoint = "http://localhost:9191/realms/master/protocol/openid-connect/token";

        document.getElementById("loginButton").onclick = function() {
            var redirectUri = window.location.href;
            var args = new URLSearchParams({
                client_id: "onlineshop",
                scope: "openid",
                response_type: "code",
                redirect_uri: redirectUri
            });
            window.location = authorizeEndpoint + "/?" + args;
        }

        async function generateCodeChallenge(codeVerifier) {
            var digest = await crypto.subtle.digest("SHA-256",
                new TextEncoder().encode(codeVerifier));

            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_')
        }

        function generateRandomString(length) {
            var text = "";
            var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

            for (var i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }

            return text;
        }

        if (window.location.search) {
            var args = new URLSearchParams(window.location.search);
            var code = args.get("code");

            if (code) {
                fetch(tokenEndpoint, {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        client_id: "onlineshop",
                        scope: "openid",
                        grant_type: "authorization_code",
                        redirect_uri: location.href.replace(location.search, ''),
                        code: code
                    })
                }
                ).then(response => response.json()
                ).then(json => {
                    document.getElementById("result").innerHTML = json.access_token;
                });
            }
        }
    </script>
  </body>
</html>
